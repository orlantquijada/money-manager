# Spending & Activity Redesign Progress

## Quick Reference
- PRD: docs/specs/spending-activity-redesign.json
- Main files: apps/mobile/src/app/(app)/(tabs)/(dashboard)/_layout.tsx

---

## Progress Log

### 2026-01-14 - Initial implementation session

[SAR-002] COMPLETE - Dashboard tab renamed to "Activity"
- Changed TabButton text from "Transactions" to "Activity"
- Route name unchanged for backward compat
- File: apps/mobile/src/app/(app)/(tabs)/(dashboard)/_layout.tsx:56

[SAR-017, SAR-018, SAR-019, SAR-020] COMPLETE - UI components (carried from prior work)
- Period chips, donut chart, stats header, empty states already implemented
- Marked as passes:true in spec JSON

[SAR-012] COMPLETE - Store picker shows lastUsedFund inline + auto-fills fund
- API: store.list now joins lastSelectedFund relation to get fund name
- Type: StorePick extended with lastSelectedFundName field
- UI: StoreRow displays "StoreName (FundName)" when fund exists
- Auto-fill logic already existed in selectStoreWithFundDefault()
- Files: packages/api/src/router/stores.ts, packages/api/src/utils/types.ts,
         apps/mobile/src/components/add-expense/store-picker-sheet.tsx

[SAR-001] COMPLETE - Bottom nav tabs now show text labels
- Added label field to RouteConfig type
- Labels: "Home", "Add", "Spending"
- TabItem renders label below icon with animated opacity
- File: apps/mobile/src/components/tab-bar.tsx

[SAR-013] COMPLETE - transaction.stats returns comparison data
- Added getPreviousPeriodDateRange() helper for previous period calculation
- stats endpoint now queries previous period total
- Returns comparison: { previousTotal, difference, percentageChange }
- comparison undefined for "all" period or when no previous data
- File: packages/api/src/router/transactions.ts

[SAR-003] COMPLETE - Comparative context shows spending vs previous period
- Added ComparisonText component to stats-header.tsx
- Displays "â†‘ â‚±X vs last [period]" (red) when spent more
- Displays "â†“ â‚±X vs last [period]" (green) when spent less
- Displays "Similar to [period]" (muted) when within Â±5%
- Hidden for "all" period or when no previous data
- Files: apps/mobile/src/components/stats/stats-header.tsx,
         apps/mobile/src/app/(app)/(tabs)/transactions.tsx

[SAR-014] COMPLETE - transaction.stats returns budget data per fund
- byFund now includes budgetedAmount and budgetUtilization fields
- budgetedAmount from funds.budgetedAmount (converted to number)
- budgetUtilization = (spent / budget) * 100
- Both undefined for funds with no budget
- File: packages/api/src/router/transactions.ts

[SAR-004] COMPLETE - Pie chart center label shows budget context on slice tap
- Updated FundData and PieSlice types to include budgetedAmount
- CenterLabel shows third line when slice selected:
  - Budgeted: "â‚±12,000 / â‚±15,000" format
  - Non-budgeted: "â‚±2,500 spent" format
- Budget line hidden when no slice selected
- File: apps/mobile/src/components/stats/pie-chart-segmented.tsx

[SAR-015] COMPLETE - budget.alerts endpoint returns prioritized alerts
- Created new budgetRouter with alerts endpoint
- Returns array of BudgetAlert with type, fundId, fundName, message, severity
- Over-budget (>100%): type='over_budget', severity='warning'
- Almost-over (>90%): type='almost_over', severity='info'
- Sorted by severity (warnings first)
- Files: packages/api/src/router/budget.ts, packages/api/src/router/index.ts

[SAR-006] COMPLETE - Budget alerts section shows prioritized alerts in Activity tab
- Created BudgetAlerts component in apps/mobile/src/components/dashboard/budget-alerts.tsx
- Max 3 alerts displayed with emoji icons (âš ï¸ over-budget, ðŸ”¶ almost-over)
- Tapping alert navigates to /fund/[id] detail view
- Integrated into Activity tab above TransactionList
- Files: apps/mobile/src/components/dashboard/budget-alerts.tsx,
         apps/mobile/src/app/(app)/(tabs)/(dashboard)/transactions.tsx

[SAR-007] COMPLETE - Recent transactions show last 7 days
- API: Added allLast7Days query returning transactions from past 7 days
- TransactionList: Added showSeeAllLink prop for "See all spending â†’" footer
- Activity tab: Switched from allThisMonth to allLast7Days query
- Activity tab: Enabled showSeeAllLink to navigate to Spending tab
- Files: packages/api/src/router/transactions.ts,
         apps/mobile/src/components/transactions/transaction-list.tsx,
         apps/mobile/src/app/(app)/(tabs)/(dashboard)/transactions.tsx

[SAR-016] COMPLETE - budget.score endpoint returns score with factors
- Added score procedure to budgetRouter
- Returns: score (0-100), status (on_track|needs_attention|over_budget), factors[]
- Calculation: Base 100, -20 per fund >100%, -5 per fund >90%, +10 if >80% under
- Empty state (no budgeted funds) returns score=100, status=on_track
- File: packages/api/src/router/budget.ts

[SAR-008, SAR-009, SAR-010] COMPLETE - Budget Score UI in dashboard header
- Replaced ProgressIndicator with BudgetScoreIndicator in TotalSpent
- Score displays as tappable pill with emoji + number (e.g., ðŸŸ¢ 78)
- Emoji: ðŸŸ¢ 70-100 (on_track), ðŸŸ¡ 40-69 (needs_attention), ðŸ”´ 0-39 (over_budget)
- Created BudgetScoreSheet bottom sheet for expandable breakdown
- Breakdown shows factors with +/- points and status label
- SAR-009 (calculation) already done in API via SAR-016
- Files: apps/mobile/src/components/dashboard/total-spent.tsx,
         apps/mobile/src/components/dashboard/budget-score-sheet.tsx,
         apps/mobile/src/app/(app)/(tabs)/(dashboard)/_layout.tsx

[BUG FIX] budget.score and budget.alerts now handle timeMode correctly
- Added getMonthlyBudget() helper to scale budgets based on timeMode
- WEEKLY: budgetedAmount Ã— (daysInMonth / 7)
- MONTHLY: budgetedAmount (unchanged)
- BIMONTHLY: budgetedAmount Ã— 2
- EVENTUALLY: excluded from score calculation (no recurring budget)
- File: packages/api/src/router/budget.ts

[SAR-011] COMPLETE - AI toggle in settings controls whispers only
- Created preferences store with MMKV persistence (aiInsightsEnabled defaults to false)
- Created SettingsSheet bottom sheet with "Enable AI Insights" toggle
- Created SettingsGear icon and added to icons/index.ts
- Added settings button to dashboard header next to add button
- Budget Score remains visible regardless of toggle (not gated by AI setting)
- Files: apps/mobile/src/stores/preferences.ts,
         apps/mobile/src/components/dashboard/settings-sheet.tsx,
         apps/mobile/src/icons/settings-gear.tsx,
         apps/mobile/src/app/(app)/(tabs)/(dashboard)/_layout.tsx

---

[SAR-007] BUG FIX - "See all spending" navigation in nested tabs
- Original: expo-router router.navigate() didn't work inside nested MaterialTopTabs
- Fix: Use React Navigation getParent().navigate() to target parent navigator
- File: apps/mobile/src/components/transactions/transaction-list.tsx

---

## Blockers
(none)

## Key Decisions
- Route href/name kept as "transactions" to avoid breaking navigation
